<!DOCTYPE html>
<html>
  <head>
    <title>char-rnn</title>
    <meta charset="utf-8">
    <meta content="initial-scale=1, minimum-scale=1, width=device-width" name="viewport">
    <script src="http://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    
    <style>
      body{ padding:20px; padding-top:0px;}
      #form_net_sample{max-width:650px;margin-right:auto;margin-left:auto;}
      .description{font-weight:200;font-size:13px;}
      label{margin-top:5px;}
    </style>
    
    <script>
    function wash(text){
		var rule_empty = [ /\n/g, /\s+/g, /\d+/g, /（）|【.*?】|〖.*?〗|['"‘“’”]/g ];
		for (var i = 0; i < rule_empty.length; ++i) text = text.replace(rule_empty[i], '');
		var ends = Math.max(text.lastIndexOf(','), text.lastIndexOf('.'), text.lastIndexOf('，'), text.lastIndexOf('。'), text.lastIndexOf('?'), text.lastIndexOf('？'), text.lastIndexOf('！'), text.lastIndexOf('!'));
		text = text.substr(0, ends + 1);
		if (text[ends] == ',' || text[ends] == '，') text = text.substr(0, text.length-1) + '。';
		return text;
    }
    function callRPC(inputdata) {        
        $.ajax({
          type: "POST",
          contentType: "application/json; charset=utf-8",
          url: "/rpc",
          data: JSON.stringify(inputdata),
          success: function (data) {
			  text = wash(data.output);
		      var v = $('#form_output').val()
			  v += '[' + inputdata['model'] + ']\n' + text + '\n';
			  $('#form_output').val(v);
			  --window.dialog;
			  inputdata['primetext'] = text;
			  inputdata['model'] = $('option')[parseInt(Math.random()*$('option').length)].value;
			  
			  if (window.dialog > 0) callRPC(inputdata);
	      },
          dataType: "json"
        });
    }
    $(function() { 
		$.get('/models', function(data) {
			for (var i = 0; i < data.models.length; ++i)
				$('#form_model').append('<option vallue="TXT">TXT</option>'.replace(/TXT/g, data.models[i]));
		});
        $( "button" ).click(function( event ) {
			$('#form_output').val('');
			var primetext = $('#form_input').val();
			if(primetext.length <= 0){primetext = '';}
			var temperature = $('#form_temperature').val();
			if(temperature <= 0 || temperature > 10){temperature = '1';}
			var seed = $('#form_seed').val();
			if(seed.length <= 0){seed = '123';}
			var length = parseInt($('#form_length').val());
			if (length <= 0) length = 100;
			window.dialog = parseInt($('#form_dialog').val()); // <-- THIS IS GLOBAL!
			window.dialog = (dialog < 1) ? 1 : ((dialog > 10) ? 10 : dialog);
			callRPC({"primetext":primetext, "temperature":temperature, "seed":seed, "model":$('#form_model').val(), "length":length});
			$('#form_seed').val(new Date().getTime()%10240);
			return false;
        });
    });
    </script>
  </head>
  <body>
    
    <form method="post" id="form_net_sample" class="form-group">
		<label for="form_model">model<span class="description"></span></label>
      <select name="form_model" class="form-control" id="form_model" placeholder="model name"></select>
		<label for="form_input">primetext<span class="description"></span></label>
      <input name="form_input" type="text" class="form-control" id="form_input" placeholder="your text" value="">
      <label for="form_temperature">temperature<span class="description">(0-1)</span></label>
      <input name="form_temperature" type="text" class="form-control" id="form_temperature" placeholder="0.7" value="0.7">
      <label for="form_seed">seed<span class="description"> (any number)</span></label>
      <input name="form_seed" type="text" class="form-control" id="form_seed" placeholder="1" value="1">
      <label for="form_length">length<span class="description"> (any number)</span></label>
      <input name="form_length" type="text" class="form-control" id="form_length" placeholder="200" value="200">
      <label for="form_dialog">dialog<span class="description"> (1-10)</span></label>
      <input name="form_dialog" type="text" class="form-control" id="form_dialog" placeholder="1" value="1">

      <br/>
      <button type="button" class="btn btn-default">submit</button>  
      <br/><br/>
      
      <label for="form_output">result</label>
      <textarea disabled name="form_output" id="form_output" class="form-control" rows="15"></textarea>
    </form>
  </body>
</html>
